---
title: 基于容器方式-MySQL 主从配置实践
date: 2021-09-05 13:16:07
tags:
  - docker
  - mysql
---

![壁纸](03.jfif)

本文，基于 docker-compose 实现了 mysql 主从数据库的配置。

<!--more-->

#### 1. 概述

本文，基于 docker-compose 实现了 mysql 主从数据库的配置。

> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MySQL 的复制功能，可以非常方便的将一个数据库中的数据复制到很多台 MySQL 主机上面，组成一个 MySQL 集群，然后通过这个MySQL 来对外提供服务。这样，每台MySQL 主机所需承担的负载就会大大降低，整个MySQL 集群的处理能力也很容易得到提升。
>
>​	<span style="float:right;margin-right:20px;">---MySQL 性能调优与架构设计</span>



[GIT 仓库地址](https://gitee.com/shadowbubble/mysql-master-salve-example)



项目目录结构：

![项目目录结构图](01.png)





#### 2. MySQL 主从配置



##### 2.1 mysql-master 主数据库的配置参数

a. 主数据库的配置文件 mysql.cnf 

​	***路径: ./mysql-master/conf.d/mysql.cnf***

```
[mysqld]

log-bin=mysql-bin		# 开启二进制日志
server-id=1			# 设置 server-id
```



b. 创建用户的SQL文件 init_db.sql

​	***路径： ./mysql-master/docker-entrypoint-inidb.d/init_db.sql***

```mysql
-- 创建用于主从同步的任务
use mysql;
create user 'repl'@'%' identified by 'slavepass';
grant replication slave on *.* to 'repl'@'%';
flush privileges;

show master status;
```



c. 运行 mysql-master 主数据库

```shell
docker-compose build mysql-master

docker-compose up -d mysql-master
```





d. 查看 master 状态, 记录二进制文件名和位置

```shell
docker-compose exec mysql-master sh -c 'exec mysql -uroot -p"$MYSQL_ROOT_PASSWORD" -e "show master status;"'
```



**mysql-master 指令命令一览**

![mysql-master 执行命令一览](02.png)

如上图所示：可以查询到 二进制日志文件为 <span style="color:red;">mysql-bin.000003, Position 为 154</span>.

<br>

##### 2.2 配置 mysql-slave-a 从数据库-a

*a. 根据路径，更新从数据库的配置文件 mysql.cnf*

​	***路径： ./mysql-slave-a/conf.d/mysql.cnf***



```
[mysqld]

server-id=2
```



b. 运行 mysql-slave-a 从数据库

```shell
docker-compose build mysql-slave-a

docker-compose up -d mysql-slave-a
```



c. 启动 mysql-slave-a 的 slave 同步进程

```shell
mysql -uroot -p -P8001 -h127.0.0.1


change MASTER TO \
	MASTER_HOST='mysql-master', \
	MASTER_USER='repl', \
	MASTER_PASSWORD='slavepass', \
	MASTER_LOG_FILE='mysql-bin.000003', \
	MASTER_LOG_POS=154;

start slave;
show slave status;
```

**<span style="color:red;">【注】： MASTER_LOG_FILE 与 MASTER_LOG_POS 的内容填写 2.1 所示命令实际读取的结果。</span>**

**mysql-slave-a 执行命令一览**

![mysql-slave-a 执行指令一览](05.png)

<br><br>

##### 2.3 配置 mysql-slave-b 从数据库-b

+ a. 根据路径，更新从数据库的配置文件 mysql.cnf

​	***路径： ./mysql-slave-b/conf.d/mysql.cnf***



```
[mysqld]
server-id=3
```



b. 运行 mysql-slave-b 从数据库

```shell
docker-compose build mysql-slave-b

docker-compose up -d mysql-slave-b
```



c. 启动 mysql-slave-b 的 slave 同步进程

```shell
mysql -uroot -p -P8002 -h127.0.0.1


change MASTER TO \
	MASTER_HOST='mysql-master', \
	MASTER_USER='repl', \
	MASTER_PASSWORD='slavepass', \
	MASTER_LOG_FILE='mysql-bin.000003', \
	MASTER_LOG_POS=154;

start slave;
show slave status;
```

**<span style="color:red;">【注】： MASTER_LOG_FILE 与 MASTER_LOG_POS 的内容填写 2.1 所示命令实际读取的结果。</span>**



**mysql-slave-b 执行命令一览**

![mysql-slave-b 执行指令一览](06.png)

<br><br>



#### 3. 数据同步测试

mysql-master 主数据库，创建测试数据库，数据表与数据记录，检查从数据库的数据，是否正常同步。



进程列表:

![进程列表](07.png)



##### 3.1 mysql-master 测试命令

```mysql
mysql -uroot -p -P8000 -h127.0.0.1

create database test_db;
use test_db;

create table test_tab_user(
	id INTEGER PRIMARY KEY AUTO_INCREMENT COMMENT '用户编号',
    name CHAR(32) NOT NULL COMMENT '用户名'
);

insert into test_tab_user(NAME) values ("nancy"), ("apply"), ("tom"), ("jerry");

select * from test_tab_user;
```



**mysql-master 测试命令一览**

![](08.png)



##### 3.2 mysql-slave-a 测试命令

```mysql
mysql -uroot -p -P8001 -h127.0.0.1

select * from test_db.test_tab_user;
```

**mysql-slave-a 测试结果一览**

![](09.png)



##### 3.3 mysql-slave-b 测试命令

```mysql
mysql -uroot -p -P8002 -h127.0.0.1

select * from test_db.test_tab_user;
```

**mysql-slave-b 测试结果一览**

![](10.png)



<br><br>

**至此，可以发现mysql-master, mysql-slave-a, mysql-slave-b 三者按预期进行同步。**



<br>

**参考资料**

1. 《MySQL 经典教程》
2. 《MySQL性能调优与架构设计》

3.  [MySQL主从简单配置](https://www.cnblogs.com/lelehellow/p/9633315.html)

4.  [mysql Official Image-Document](https://hub.docker.com/_/mysql)
5. [Hexo 主题模板案例-喜欢这个排版](https://d2fan.com/)



<br><br>































































